<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Ú¯Ø±Ø¯ÙˆÙ†Ù‡ Ø´Ø§Ù†Ø³ Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø§ÛŒØ±Ø§Ù†Ù…Ù‡Ø±</title>
<link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
<style>
:root{
  --red: #a71d31;
  --green: #2a5934;
  --white: #fdfbf7;
  --gold: #ffc845;
  --dark: #2b0010;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:'Vazirmatn',sans-serif;direction:rtl;overflow:hidden}

body {
    background: radial-gradient(circle at top, #800020, #1a0505);
    color: var(--white);
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 10px;
}

.header { text-align: center; z-index: 2; margin-top: 5px; }
.logo { font-size: 1.5rem; font-weight: 900; color: var(--gold); text-shadow: 0 2px 5px rgba(0,0,0,0.5); }
.desc { font-size: 0.85rem; opacity: 0.9; margin-top: 2px; }

/* Ù†Ú¯Ù‡Ø¯Ø§Ø±Ù†Ø¯Ù‡ Ú¯Ø±Ø¯ÙˆÙ†Ù‡ */
.wheel-container {
    position: relative;
    width: 330px;
    height: 330px;
    margin: 15px auto;
    filter: drop-shadow(0 10px 20px rgba(0,0,0,0.5));
}

/* Ù†Ø´Ø§Ù†Ú¯Ø± Ø¨Ø§Ù„Ø§ */
.stopper {
    position: absolute;
    top: -15px;
    left: 50%;
    transform: translateX(-50%);
    width: 50px;
    height: 60px;
    z-index: 20;
    background: linear-gradient(to bottom, var(--gold), #ffdf80);
    clip-path: polygon(50% 100%, 15% 10%, 85% 10%);
    filter: drop-shadow(0 4px 2px rgba(0,0,0,0.4));
}

/* Ø®ÙˆØ¯ Ø¯Ø§ÛŒØ±Ù‡ Ú¯Ø±Ø¯ÙˆÙ†Ù‡ */
.wheel {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    background: #fff;
    border: 12px solid #fff;
    box-shadow: inset 0 0 20px rgba(0,0,0,0.2);
    position: relative;
    overflow: hidden;
    transition: transform 5s cubic-bezier(0.2, 0.8, 0.2, 1);
}

/* Ø¬Ø¯Ø§Ú©Ù†Ù†Ø¯Ù‡â€ŒÙ‡Ø§ Ùˆ Ù…ØªÙ†â€ŒÙ‡Ø§ */
.segment {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    clip-path: polygon(50% 50%, 100% 0, 100% 0);
    transform-origin: 50% 50%;
}

.segment-label {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 50%;
    transform-origin: 50% 100%;
    display: flex;
    justify-content: center;
    padding-top: 25px;
    font-size: 14px;
    font-weight: 800;
    text-shadow: 0 1px 2px rgba(0,0,0,0.2);
}

/* Ù…Ø±Ú©Ø² Ú¯Ø±Ø¯ÙˆÙ†Ù‡ */
.center-circle {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    width: 60px; height: 60px;
    background: radial-gradient(circle, #fff 40%, #ddd 100%);
    border: 5px solid var(--gold);
    border-radius: 50%;
    z-index: 10;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    display: flex; align-items: center; justify-content: center;
    color: var(--red);
    font-weight: 900;
}

/* Ù¾Ù†Ù„ ÙˆØ±ÙˆØ¯ÛŒ */
.controls {
    width: 100%;
    max-width: 350px;
    background: rgba(255,255,255,0.1);
    backdrop-filter: blur(8px);
    padding: 15px;
    border-radius: 16px;
    border: 1px solid rgba(255,255,255,0.15);
    display: flex;
    flex-direction: column;
    gap: 10px;
}

input {
    width: 100%;
    padding: 12px;
    border-radius: 10px;
    border: 2px solid transparent;
    background: rgba(255,255,255,0.9);
    font-family: inherit;
    font-size: 1rem;
    text-align: center;
    color: #333;
    font-weight: bold;
}
input:focus { outline: none; border-color: var(--gold); }

button {
    width: 100%;
    padding: 14px;
    border-radius: 10px;
    border: none;
    background: linear-gradient(135deg, var(--gold), #ffb300);
    color: #5c001a;
    font-weight: 900;
    font-size: 1.1rem;
    cursor: pointer;
    box-shadow: 0 4px 15px rgba(255, 195, 0, 0.3);
    transition: transform 0.1s;
    position: relative;
    overflow: hidden;
}
/* Ø§ÙÚ©Øª Ø´Ø§ÛŒÙ† Ø¨Ø±Ø§ÛŒ Ø¯Ú©Ù…Ù‡ */
button::after {
    content: '';
    position: absolute;
    top: 0; left: -100%; width: 100%; height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
    animation: shine 3s infinite;
}
@keyframes shine { 100% { left: 100%; } }

button:active { transform: scale(0.98); }
button:disabled { background: #999; color: #555; box-shadow: none; cursor: default; }
button:disabled::after { display: none; }

.status-msg { font-size: 0.8rem; text-align: center; opacity: 0.8; }

/* Ù…ÙˆØ¯Ø§Ù„ */
.modal-overlay {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.85);
    z-index: 100;
    display: none;
    align-items: center; justify-content: center;
    backdrop-filter: blur(5px);
}
.modal-card {
    background: #fff;
    width: 85%; max-width: 320px;
    border-radius: 20px;
    padding: 25px 20px;
    text-align: center;
    color: #333;
    animation: zoomIn 0.3s ease;
    border: 4px solid var(--gold);
    position: relative;
}
@keyframes zoomIn { from{transform:scale(0.5);opacity:0} to{transform:scale(1);opacity:1} }
.modal-prize { color: var(--red); font-size: 1.8rem; font-weight: 900; margin: 10px 0; }

/* Ø§Ø³ØªØ§ÛŒÙ„ Ù¾ÛŒØ§Ù… Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ */
.ai-message-box {
    margin-top: 15px;
    padding: 12px;
    background: linear-gradient(135deg, #fff8e1, #fff);
    border-radius: 12px;
    border: 1px dashed var(--gold);
    font-size: 0.9rem;
    color: #5c001a;
    line-height: 1.6;
    min-height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-style: italic;
}
.sparkles { font-size: 1.2rem; }
</style>
</head>
<body>

<div class="header">
  <div class="logo">ğŸ‰ ÛŒÙ„Ø¯Ø§ÛŒ Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø§ÛŒØ±Ø§Ù†Ù…Ù‡Ø±</div>
  <div class="desc">Ø§Ø³Ù…â€ŒØª Ø±Ùˆ Ø¨Ù†ÙˆÛŒØ³ Ùˆ Ø´Ø§Ù†Ø³Øª Ø±Ùˆ Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†!</div>
</div>

<div class="wheel-container">
  <div class="stopper"></div>
  <div class="wheel" id="wheel"></div>
  <div class="center-circle">Play</div>
</div>

<div class="controls">
  <input type="text" id="nameInput" placeholder="Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ" autocomplete="off" />
  <button id="spinBtn">âœ¨ Ú†Ø±Ø®Ø´ Ú¯Ø±Ø¯ÙˆÙ†Ù‡ Ø´Ø§Ù†Ø³ âœ¨</button>
  <div class="status-msg" id="statusMsg">Ù‡Ø± Ù†ÙØ± ÙÙ‚Ø· ÛŒÚ©Ø¨Ø§Ø± Ø§Ù…Ú©Ø§Ù† Ø´Ø±Ú©Øª Ø¯Ø§Ø±Ø¯.</div>
</div>

<div class="modal-overlay" id="resultModal">
  <div class="modal-card">
    <h2 style="margin:0;color:#333">ØªØ¨Ø±ÛŒÚ©!</h2>
    <p style="margin:5px 0">Ø¬Ø§ÛŒØ²Ù‡ Ø´Ù…Ø§:</p>
    <div class="modal-prize" id="resPrize"></div>
    
    <!-- Ø¨Ø®Ø´ Ù¾ÛŒØ§Ù… Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ -->
    <div class="ai-message-box" id="aiBox">
        <span style="opacity:0.6">âœ¨ Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª ÙØ§Ù„ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ...</span>
    </div>

    <p style="font-size:0.8rem;color:#666;margin-top:15px">Ù†ØªÛŒØ¬Ù‡ Ø±ÙˆÛŒ ØªÙ„ÙˆÛŒØ²ÛŒÙˆÙ† Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯.<br>Ù„Ø·ÙØ§Ù‹ Ø¨Ù‡ Ù¾Ø°ÛŒØ±Ø´ Ù…Ø±Ø§Ø¬Ø¹Ù‡ Ú©Ù†ÛŒØ¯.</p>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getDatabase, ref, push } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

// --- ØªÙ†Ø¸ÛŒÙ…Ø§Øª Gemini API ---
const apiKey = ""; // Ú©Ù„ÛŒØ¯ API Ø¨Ù‡ ØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ø¯Ø± Ù…Ø­ÛŒØ· Ø§Ø¬Ø±Ø§ Ù¾Ø± Ù…ÛŒâ€ŒØ´ÙˆØ¯
const MODEL_NAME = "gemini-2.5-flash-preview-09-2025";

const firebaseConfig = {
  apiKey: "AIzaSyC2hX016YUfRGTaJ913oMXCUnaY-IbvLUs",
  authDomain: "iranmehr-6518f.firebaseapp.com",
  databaseURL: "https://iranmehr-6518f-default-rtdb.firebaseio.com",
  projectId: "iranmehr-6518f",
  storageBucket: "iranmehr-6518f.firebasestorage.app",
  messagingSenderId: "171332068534",
  appId: "1:171332068534:web:4391388fbcf4b3e74b3217",
  measurementId: "G-GM9HBHCF6K"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// Ù„ÛŒØ³Øª Ø¬ÙˆØ§ÛŒØ²
const items = [
  { label: "Ûµ Ù…ÛŒÙ„ÛŒÙˆÙ† Ø§Ø¹ØªØ¨Ø§Ø±", bg: "#a71d31", txt: "#fff" }, 
  { label: "ÛµÛ°Ùª ØªØ®ÙÛŒÙ",       bg: "#fdfbf7", txt: "#a71d31" }, 
  { label: "Û± Ù…ÛŒÙ„ÛŒÙˆÙ† Ø§Ø¹ØªØ¨Ø§Ø±", bg: "#2a5934", txt: "#fff" }, 
  { label: "Û² Ù…ÛŒÙ„ÛŒÙˆÙ† Ø§Ø¹ØªØ¨Ø§Ø±", bg: "#a71d31", txt: "#fff" }, 
  { label: "Û² Ø¬Ù„Ø³Ù‡ Ù„ÛŒØ²Ø±",     bg: "#fdfbf7", txt: "#2a5934" }, 
  { label: "Û± Ø¬Ù„Ø³Ù‡ Ù„ÛŒØ²Ø±",     bg: "#2a5934", txt: "#fff" }, 
  { label: "Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ø±Ø§ÛŒÚ¯Ø§Ù†",  bg: "#a71d31", txt: "#fff" }, 
  { label: "Û² Ù…ÛŒÙ„ÛŒÙˆÙ† ØªØ®ÙÛŒÙ",  bg: "#fdfbf7", txt: "#a71d31" }  
];

const wheel = document.getElementById('wheel');
const spinBtn = document.getElementById('spinBtn');
const nameInput = document.getElementById('nameInput');

function initWheel() {
    const numItems = items.length;
    const arc = 360 / numItems; 

    let gradient = [];
    items.forEach((item, i) => {
        const start = i * arc;
        const end = (i + 1) * arc;
        gradient.push(`${item.bg} ${start}deg ${end}deg`);
        
        const label = document.createElement('div');
        label.className = 'segment-label';
        label.style.transform = `rotate(${start + arc/2}deg)`; 
        label.style.color = item.txt;
        
        const textSpan = document.createElement('span');
        textSpan.innerText = item.label;
        textSpan.style.width = '70px'; 
        textSpan.style.textAlign = 'center';
        textSpan.style.lineHeight = '1.2';
        
        label.appendChild(textSpan);
        wheel.appendChild(label);
    });

    wheel.style.background = `conic-gradient(${gradient.join(', ')})`;
}

initWheel();

const storageKey = 'iranmehr_yalda_ai_v1';
if(localStorage.getItem(storageKey)){
    disableGame('Ø´Ù…Ø§ Ù‚Ø¨Ù„Ø§Ù‹ Ø´Ø±Ú©Øª Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯.');
}

// ØªØ§Ø¨Ø¹ ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Ø¬Ù…Ù†Ø§ÛŒ
async function getGeminiMessage(userName, prizeName) {
    if (!apiKey) return null; // Ø§Ú¯Ø± Ú©Ù„ÛŒØ¯ Ù†Ø¨Ø§Ø´Ø¯ØŒ Ù¾ÛŒØ§Ù… Ø®Ø§Ù„ÛŒ Ø¨Ø±Ù…ÛŒâ€ŒÚ¯Ø±Ø¯Ø¯

    const prompt = `Write a short, warm, and witty Persian congratulatory message for '${userName}' who won '${prizeName}' in the Yalda lottery of 'Iranmehr Beauty Clinic'. Mention Yalda night symbols like pomegranate or watermelon implicitly. Keep it under 20 words. Add one relevant emoji.`;

    try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${apiKey}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: [{ parts: [{ text: prompt }] }]
            })
        });

        const data = await response.json();
        const aiText = data.candidates?.[0]?.content?.parts?.[0]?.text;
        return aiText || "ØªØ¨Ø±ÛŒÚ© ÙˆÛŒÚ˜Ù‡ Ø¨Ù‡ Ø´Ù…Ø§!";
    } catch (error) {
        console.error("Gemini API Error:", error);
        return null;
    }
}

spinBtn.addEventListener('click', async () => {
    const name = nameInput.value.trim();
    if(!name || name.length < 3) return alert('Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ú©Ø§Ù…Ù„ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.');

    spinBtn.disabled = true;
    nameInput.disabled = true;

    // --- Ù…Ù†Ø·Ù‚ Ø­Ø°Ù Ø´Ø§Ù†Ø³ Ûµ Ù…ÛŒÙ„ÛŒÙˆÙ† ---
    const allowedIndices = [];
    items.forEach((item, idx) => {
        if(item.label !== "Ûµ Ù…ÛŒÙ„ÛŒÙˆÙ† Ø§Ø¹ØªØ¨Ø§Ø±") {
            allowedIndices.push(idx);
        }
    });
    const rand = Math.floor(Math.random() * allowedIndices.length);
    const index = allowedIndices[rand];
    const winItem = items[index];

    // --- Ø´Ø±ÙˆØ¹ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ù‡Ù…Ø²Ù…Ø§Ù† Ø¨Ø§ Ú†Ø±Ø®Ø´ ---
    // Ø§ÛŒÙ† Ù¾Ø±Ø§Ù…ÛŒØ³ (Promise) Ø¯Ø± Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡ Ø§Ø¬Ø±Ø§ Ù…ÛŒâ€ŒØ´ÙˆØ¯
    const aiMessagePromise = getGeminiMessage(name, winItem.label);

    const arc = 360 / items.length;
    const itemCenterAngle = (index * arc) + (arc / 2);
    const targetRotate = 360 - itemCenterAngle; 
    const totalRotate = 2880 + targetRotate; // 8 Ø¯ÙˆØ± Ú†Ø±Ø®Ø´

    wheel.style.transform = `rotate(${totalRotate}deg)`;

    // Ø²Ù…Ø§Ù† Ø§Ù†ÛŒÙ…ÛŒØ´Ù† (Ûµ Ø«Ø§Ù†ÛŒÙ‡)
    setTimeout(async () => {
        document.getElementById('resPrize').innerText = winItem.label;
        document.getElementById('resultModal').style.display = 'flex';
        confetti({ zIndex: 200, particleCount: 150, spread: 70, origin: { y: 0.6 } });

        // Ø¯Ø±ÛŒØ§ÙØª Ù†ØªÛŒØ¬Ù‡ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ (Ø§Ú¯Ø± Ø²ÙˆØ¯ØªØ± Ø¢Ù…Ø§Ø¯Ù‡ Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯ØŒ Ù…Ù†ØªØ¸Ø± Ù†Ù…ÛŒâ€ŒÙ…Ø§Ù†ÛŒÙ…)
        let aiMsg = null;
        try {
            aiMsg = await aiMessagePromise;
        } catch(e) { console.log("AI took too long"); }

        // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ø¯Ø± Ù…ÙˆØ¯Ø§Ù„
        const aiBox = document.getElementById('aiBox');
        if (aiMsg) {
            aiBox.innerHTML = `âœ¨ ${aiMsg}`;
        } else {
            aiBox.innerHTML = `âœ¨ ÛŒÙ„Ø¯Ø§ÛŒØªØ§Ù† Ù…Ø¨Ø§Ø±Ú© Ùˆ Ù¾Ø± Ø§Ø² Ø²ÛŒØ¨Ø§ÛŒÛŒ!`;
            aiMsg = "ÛŒÙ„Ø¯Ø§ÛŒØªØ§Ù† Ù…Ø¨Ø§Ø±Ú©!";
        }

        try {
            await push(ref(db, 'results'), {
                name: name,
                prize: winItem.label,
                aiMessage: aiMsg, // Ø°Ø®ÛŒØ±Ù‡ Ù¾ÛŒØ§Ù… Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ø¨Ø±Ø§ÛŒ ØªÙ„ÙˆÛŒØ²ÛŒÙˆÙ†
                time: Date.now()
            });
            localStorage.setItem(storageKey, 'true');
            document.getElementById('statusMsg').innerText = 'Ù†ØªÛŒØ¬Ù‡ Ø«Ø¨Øª Ø´Ø¯.';
        } catch(e) {
            alert('Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø§ÛŒÙ†ØªØ±Ù†ØªØŒ Ø§Ù…Ø§ Ø¨Ø±Ø¯ Ø´Ù…Ø§ Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª.');
        }

    }, 5000);
});

function disableGame(msg){
    spinBtn.disabled = true;
    nameInput.disabled = true;
    spinBtn.innerText = 'Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡';
    spinBtn.style.background = '#ccc';
    document.getElementById('statusMsg').innerText = msg;
}
</script>
</body>
</html>